<!DOCTYPE html>
<html>
  <head>
    <title>AR Art: SpaceRunner</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.1.4/dist/mindar-image-aframe.prod.js"></script>
    <style>
      body, html { margin: 0; overflow: hidden; font-family: sans-serif; }
      a-scene { background-color: black; }
      #startAR {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 2;
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
      }
      #unsupported, #no-camera {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        display: none;
      }
    </style>
  </head>
  <body>

    <button id="startAR">Start AR</button>
    <div id="unsupported">⚠️ Your device does not support AR or WebXR.<br>Please try using a newer mobile device or browser.</div>
    <div id="no-camera">⚠️ Camera access is blocked or not available.<br>Please allow camera permissions in your browser settings.</div>

    <a-scene 
      mindar-image="imageTargetSrc: ./assets/targets.mind;" 
      embedded 
      color-space="sRGB" 
      vr-mode-ui="enabled: false" 
      device-orientation-permission-ui="enabled: true"
      loading-screen="enabled: true">

      <a-assets>
        <a-asset-item id="spacerunner" src="./assets/spacerunners.glb"></a-asset-item>
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: true"></a-camera>

      <a-entity mindar-image-target="targetIndex: 0">
        <a-gltf-model src="#spacerunner" position="0 0 0" scale="0.25 0.25 0.25" rotation="0 180 0"></a-gltf-model>
      </a-entity>
    </a-scene>

    <script>
  const scene = document.querySelector("a-scene");
  const startBtn = document.getElementById("startAR");
  const unsupportedMsg = document.getElementById("unsupported");
  const noCameraMsg = document.getElementById("no-camera");

  async function requestPermissions() {
    // iOS motion permission
    if (typeof DeviceMotionEvent !== "undefined" &&
        typeof DeviceMotionEvent.requestPermission === "function") {
      try {
        const response = await DeviceMotionEvent.requestPermission();
        if (response !== "granted") {
          console.warn("Motion permission not granted");
        }
      } catch (err) {
        console.error("Motion permission error:", err);
      }
    }

    // iOS camera permission check
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: true });
      stream.getTracks().forEach(track => track.stop()); // immediately stop if just checking permission
    } catch (e) {
      console.error("Camera permission denied or not available:", e);
      noCameraMsg.style.display = "block";
      startBtn.style.display = "none";
      return false;
    }

    return true;
  }

  if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    unsupportedMsg.style.display = "block";
    startBtn.style.display = "none";
  }

  startBtn.addEventListener("click", async () => {
    const permissionsGranted = await requestPermissions();
    if (permissionsGranted) {
      try {
        await scene.components["mindar-image"].start();
        startBtn.style.display = "none";
      } catch (e) {
        console.error("Error starting AR scene:", e);
        noCameraMsg.style.display = "block";
      }
    }
  });
</script>

  </body>
</html>
